name: Test SAP HANA Connection and Run SELECT

on:
  push:
    branches:
      - main

jobs:
  test-hana-connection:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: SSH into SAP HANA Server and Run SELECT Query
        env:
          SSH_HOST: "176.52.135.159"
          SSH_PORT: "22234"
          SSH_USER: "jbecerra"
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
          HANA_USER: ${{ secrets.HANA_USER }}
          HANA_PASSWORD: ${{ secrets.HANA_PASSWORD }}
          SCHEMA: "SBO_20510511906_MAFIE_TEST"
        run: |
          sudo apt-get update && sudo apt-get install -y sshpass

          sshpass -p "$SSH_PASSWORD" ssh -tt -o StrictHostKeyChecking=no -p $SSH_PORT $SSH_USER@$SSH_HOST << EOF
          echo "Connection to SAP HANA Server successful"

          # Usar ruta absoluta de hdbsql y mejor manejo de errores
          sudo su - root -c '
            if cd /hana/shared/NDB/HDB00/exe; then
              echo "Access to /hana/shared/NDB/HDB00/exe successful"
              
              echo "Running SELECT query..."
              RESULT=\$(/hana/shared/NDB/HDB00/exe/hdbsql -u "$HANA_USER" -p "$HANA_PASSWORD" -d $SCHEMA -m -C "SELECT CURRENT_TIMESTAMP FROM DUMMY" 2>&1)
              
              # Filtrar salida no deseada
              CLEAN_RESULT=\$(echo "\$RESULT" | grep -P "\\d{4}-\\d{2}-\\d{2} \\d{2}:\\d{2}:\\d{2}\\.\\d+")
              
              echo "Query result:"
              echo "\$CLEAN_RESULT"
            else
              echo "Error: Failed to access HANA directory"
              exit 1
            fi
          '
          EOF

          echo "GitHub Action completed successfully"
